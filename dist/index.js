/*! For license information please see index.js.LICENSE.txt */
import*as n from"extensions";import*as e from"slash-commands";import*as t from"world-info";var r={d:(n,e)=>{for(var t in e)r.o(e,t)&&!r.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:e[t]})},o:(n,e)=>Object.prototype.hasOwnProperty.call(n,e)};const o=(i={eventSource:()=>n.eventSource,event_types:()=>n.event_types,extension_settings:()=>n.extension_settings,getContext:()=>n.getContext,saveSettingsDebounced:()=>n.saveSettingsDebounced},a={},r.d(a,i),a);var i,a;const c=(n=>{var e={};return r.d(e,n),e})({registerSlashCommand:()=>e.registerSlashCommand}),s=(n=>{var e={};return r.d(e,n),e})({world_info:()=>t.world_info});function u(){var n,e,t="function"==typeof Symbol?Symbol:{},r=t.iterator||"@@iterator",o=t.toStringTag||"@@toStringTag";function i(t,r,o,i){var s=r&&r.prototype instanceof c?r:c,u=Object.create(s.prototype);return f(u,"_invoke",function(t,r,o){var i,c,s,u=0,f=o||[],l=!1,d={p:0,n:0,v:n,a:p,f:p.bind(n,4),d:function(e,t){return i=e,c=0,s=n,d.n=t,a}};function p(t,r){for(c=t,s=r,e=0;!l&&u&&!o&&e<f.length;e++){var o,i=f[e],p=d.p,y=i[2];t>3?(o=y===r)&&(s=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=n):i[0]<=p&&((o=t<2&&p<i[1])?(c=0,d.v=r,d.n=i[1]):p<y&&(o=t<3||i[0]>r||r>y)&&(i[4]=t,i[5]=r,d.n=y,c=0))}if(o||t>1)return a;throw l=!0,r}return function(o,f,y){if(u>1)throw TypeError("Generator is already running");for(l&&1===f&&p(f,y),c=f,s=y;(e=c<2?n:s)||!l;){i||(c?c<3?(c>1&&(d.n=-1),p(c,s)):d.n=s:d.v=s);try{if(u=2,i){if(c||(o="next"),e=i[o]){if(!(e=e.call(i,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,c<2&&(c=0)}else 1===c&&(e=i.return)&&e.call(i),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=n}else if((e=(l=d.n<0)?s:t.call(r,d))!==a)break}catch(e){i=n,c=1,s=e}finally{u=1}}return{value:e,done:l}}}(t,o,i),!0),u}var a={};function c(){}function s(){}function l(){}e=Object.getPrototypeOf;var d=[][r]?e(e([][r]())):(f(e={},r,(function(){return this})),e),p=l.prototype=c.prototype=Object.create(d);function y(n){return Object.setPrototypeOf?Object.setPrototypeOf(n,l):(n.__proto__=l,f(n,o,"GeneratorFunction")),n.prototype=Object.create(p),n}return s.prototype=l,f(p,"constructor",l),f(l,"constructor",s),s.displayName="GeneratorFunction",f(l,o,"GeneratorFunction"),f(p),f(p,o,"Generator"),f(p,r,(function(){return this})),f(p,"toString",(function(){return"[object Generator]"})),(u=function(){return{w:i,m:y}})()}function f(n,e,t,r){var o=Object.defineProperty;try{o({},"",{})}catch(n){o=0}f=function(n,e,t,r){if(e)o?o(n,e,{value:t,enumerable:!r,configurable:!r,writable:!r}):n[e]=t;else{var i=function(e,t){f(n,e,(function(n){return this._invoke(e,t,n)}))};i("next",0),i("throw",1),i("return",2)}},f(n,e,t,r)}function l(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!t){if(Array.isArray(n)||(t=function(n,e){if(n){if("string"==typeof n)return d(n,e);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?d(n,e):void 0}}(n))||e&&n&&"number"==typeof n.length){t&&(n=t);var r=0,o=function(){};return{s:o,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){t=t.call(n)},n:function(){var n=t.next();return a=n.done,n},e:function(n){c=!0,i=n},f:function(){try{a||null==t.return||t.return()}finally{if(c)throw i}}}}function d(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function p(n,e,t,r,o,i,a){try{var c=n[i](a),s=c.value}catch(n){return void t(n)}c.done?e(s):Promise.resolve(s).then(r,o)}function y(n){return function(){var e=this,t=arguments;return new Promise((function(r,o){var i=n.apply(e,t);function a(n){p(i,r,o,a,c,"next",n)}function c(n){p(i,r,o,a,c,"throw",n)}a(void 0)}))}}function m(n,e){return v.apply(this,arguments)}function v(){return(v=y(u().m((function n(e,t){return u().w((function(n){for(;;)if(0===n.n)return n.a(2,JSON.stringify({entries:[]}))}),n)})))).apply(this,arguments)}function h(n){return g.apply(this,arguments)}function g(){return(g=y(u().m((function n(e){var t,r,o,i,a,c,s,f,l;return u().w((function(n){for(;;)switch(n.n){case 0:if(e&&0!==e.length){n.n=1;break}return n.a(2,{newEntries:[],updatedEntries:[]});case 1:return t=e.slice(-10),r=t.map((function(n){return"".concat(n.is_user?"User":"Character",": ").concat(n.mes)})).join("\n"),o="Analyze the following conversation and extract information for a story's World Info database:\n\n".concat(r,'\n\nFocus on:\n1. Important characters (names, descriptions, relationships)\n2. Locations (settings, places mentioned)\n3. Objects (items of significance)\n4. Concepts (rules of the world, systems, organizations)\n\nFormat your response strictly as JSON:\n{\n  "entries": [\n    {\n      "type": "character|location|object|concept",\n      "name": "Name of entity",\n      "description": "Detailed description",\n      "suggestedKeys": ["key1", "key2"],\n      "confidence": 0.0-1.0\n    }\n  ]\n}'),n.p=2,n.n=3,m(o,{});case 3:return i=n.v,a=i.indexOf("{"),c=i.lastIndexOf("}")+1,s=i.substring(a,c),f=JSON.parse(s),n.a(2,w(f.entries));case 4:return n.p=4,l=n.v,console.error("Error analyzing messages:",l),n.a(2,{newEntries:[],updatedEntries:[]})}}),n,null,[[2,4]])})))).apply(this,arguments)}function w(n){var e,t,r,o=[],i=[],a=l(n);try{for(a.s();!(e=a.n()).done;){var c=e.value,s=_(c.name,c.suggestedKeys);if(s){var u={id:s.uid,name:c.name,originalContent:s.content,newContent:c.description,mergedContent:(t=s.content,r=c.description,"".concat(t,"\n\nAdditional information:\n").concat(r)),suggestedKeys:c.suggestedKeys,type:c.type,confidence:c.confidence};i.push(u)}else o.push(c)}}catch(n){a.e(n)}finally{a.f()}return{newEntries:o,updatedEntries:i}}function _(n,e){var t=s.world_info.entries.find((function(e){return e.content.split("\n")[0].toLowerCase().includes(n.toLowerCase())}));if(t)return t;var r,o=l(e);try{var i,a=function(){var n=r.value,e=s.world_info.entries.find((function(e){return e.key.split(",").map((function(n){return n.trim().toLowerCase()})).includes(n.toLowerCase())}));if(e)return{v:e}};for(o.s();!(r=o.n()).done;)if(i=a())return i.v}catch(n){o.e(n)}finally{o.f()}return null}function b(n){return function(n){if(Array.isArray(n))return E(n)}(n)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(n)||function(n,e){if(n){if("string"==typeof n)return E(n,e);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?E(n,e):void 0}}(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function S(){var n,e=document.createElement("div");e.id="dynamicLore_button",e.className="list-group-item",e.innerHTML="<span>DynamicLore</span>";var t=document.getElementById("extensionsMenu");t&&t.appendChild(e);var r=document.createElement("div");r.id="dynamiclore_panel",r.className="drawer wide_drawer",r.style.display="none";var o=document.createElement("div");o.className="drawer-header",o.innerHTML='\n        <span class="drawer_heading">DynamicLore - World Info Manager</span>\n        <div class="menu_button fa-solid fa-xmark" id="dynamiclore_close"></div>\n    ';var i=document.createElement("div");i.className="drawer-content";var a=document.createElement("div");a.className="dynamiclore_controls",a.innerHTML='<button id="dynamiclore_analyze" class="menu_button">Analyze Conversation</button>';var c=document.createElement("div");c.className="dynamiclore_pending_updates",c.id="dynamiclore_updates",i.appendChild(a),i.appendChild(c),r.appendChild(o),r.appendChild(i),document.body.appendChild(r),e.addEventListener("click",(function(){r.style.display="none"===r.style.display?"block":"none"})),null===(n=document.getElementById("dynamiclore_close"))||void 0===n||n.addEventListener("click",(function(){r.style.display="none"}))}function O(){var n,e,t="function"==typeof Symbol?Symbol:{},r=t.iterator||"@@iterator",o=t.toStringTag||"@@toStringTag";function i(t,r,o,i){var s=r&&r.prototype instanceof c?r:c,u=Object.create(s.prototype);return j(u,"_invoke",function(t,r,o){var i,c,s,u=0,f=o||[],l=!1,d={p:0,n:0,v:n,a:p,f:p.bind(n,4),d:function(e,t){return i=e,c=0,s=n,d.n=t,a}};function p(t,r){for(c=t,s=r,e=0;!l&&u&&!o&&e<f.length;e++){var o,i=f[e],p=d.p,y=i[2];t>3?(o=y===r)&&(s=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=n):i[0]<=p&&((o=t<2&&p<i[1])?(c=0,d.v=r,d.n=i[1]):p<y&&(o=t<3||i[0]>r||r>y)&&(i[4]=t,i[5]=r,d.n=y,c=0))}if(o||t>1)return a;throw l=!0,r}return function(o,f,y){if(u>1)throw TypeError("Generator is already running");for(l&&1===f&&p(f,y),c=f,s=y;(e=c<2?n:s)||!l;){i||(c?c<3?(c>1&&(d.n=-1),p(c,s)):d.n=s:d.v=s);try{if(u=2,i){if(c||(o="next"),e=i[o]){if(!(e=e.call(i,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,c<2&&(c=0)}else 1===c&&(e=i.return)&&e.call(i),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=n}else if((e=(l=d.n<0)?s:t.call(r,d))!==a)break}catch(e){i=n,c=1,s=e}finally{u=1}}return{value:e,done:l}}}(t,o,i),!0),u}var a={};function c(){}function s(){}function u(){}e=Object.getPrototypeOf;var f=[][r]?e(e([][r]())):(j(e={},r,(function(){return this})),e),l=u.prototype=c.prototype=Object.create(f);function d(n){return Object.setPrototypeOf?Object.setPrototypeOf(n,u):(n.__proto__=u,j(n,o,"GeneratorFunction")),n.prototype=Object.create(l),n}return s.prototype=u,j(l,"constructor",u),j(u,"constructor",s),s.displayName="GeneratorFunction",j(u,o,"GeneratorFunction"),j(l),j(l,o,"Generator"),j(l,r,(function(){return this})),j(l,"toString",(function(){return"[object Generator]"})),(O=function(){return{w:i,m:d}})()}function j(n,e,t,r){var o=Object.defineProperty;try{o({},"",{})}catch(n){o=0}j=function(n,e,t,r){if(e)o?o(n,e,{value:t,enumerable:!r,configurable:!r,writable:!r}):n[e]=t;else{var i=function(e,t){j(n,e,(function(n){return this._invoke(e,t,n)}))};i("next",0),i("throw",1),i("return",2)}},j(n,e,t,r)}function x(n,e,t,r,o,i,a){try{var c=n[i](a),s=c.value}catch(n){return void t(n)}c.done?e(s):Promise.resolve(s).then(r,o)}function C(n){return function(){var e=this,t=arguments;return new Promise((function(r,o){var i=n.apply(e,t);function a(n){x(i,r,o,a,c,"next",n)}function c(n){x(i,r,o,a,c,"throw",n)}a(void 0)}))}}function L(){return A.apply(this,arguments)}function A(){return(A=C(O().m((function n(){return O().w((function(n){for(;;)switch(n.n){case 0:o.extension_settings.dynamicLore.message_count++,o.extension_settings.dynamicLore.message_count>=o.extension_settings.dynamicLore.analysis_interval&&(o.extension_settings.dynamicLore.message_count=0,k()),(0,o.saveSettingsDebounced)();case 1:return n.a(2)}}),n)})))).apply(this,arguments)}function k(){return P.apply(this,arguments)}function P(){return(P=C(O().m((function n(){var e,t;return O().w((function(n){for(;;)switch(n.n){case 0:return e=(0,o.getContext)().chat,n.n=1,h(e);case 1:(t=n.v).newEntries.length>0&&(r=t.newEntries,o.extension_settings.dynamicLore.auto_approve?(r.filter((function(n){return n.confidence>.8})).forEach((function(n){!function(n){var e={key:n.suggestedKeys.join(","),keysecondary:"",comment:"Auto-generated by DynamicLore",content:n.description,constant:!1,selective:!1};s.world_info&&s.world_info.entries&&(s.world_info.entries.push(e),"function"==typeof s.world_info.sync&&s.world_info.sync())}(n)})),r.filter((function(n){return n.confidence<=.8})).forEach((function(n){showNewEntryProposal(n)}))):r.forEach((function(n){showNewEntryProposal(n)}))),t.updatedEntries.length>0&&T(t.updatedEntries);case 2:return n.a(2)}var r}),n)})))).apply(this,arguments)}function T(n){o.extension_settings.dynamicLore.auto_approve?(n.filter((function(n){return n.confidence>.8})).forEach((function(n){!function(n){if(s.world_info&&s.world_info.entries){var e,t,r,o=s.world_info.entries.find((function(e){return e.uid===n.id}));o&&(o.content=n.mergedContent,o.key=(e=o.key,t=n.suggestedKeys,r=e.split(",").map((function(n){return n.trim()})),b(new Set([].concat(b(r),b(t)))).join(",")),"function"==typeof s.world_info.sync&&s.world_info.sync())}}(n)})),n.filter((function(n){return n.confidence<=.8})).forEach((function(n){showUpdateProposal(n)}))):n.forEach((function(n){showUpdateProposal(n)}))}o.extension_settings.dynamicLore||(o.extension_settings.dynamicLore={auto_analyze:!0,analysis_interval:5,auto_approve:!1,message_count:0}),jQuery(C(O().m((function n(){return O().w((function(n){for(;;)switch(n.n){case 0:S(),(0,c.registerSlashCommand)("dynamiclore",(function(n){return n.length>0&&"analyze"===n[0]?(k(),!0):($("#dynamiclore_panel").toggle(),!0)})),o.extension_settings.dynamicLore.auto_analyze&&(o.eventSource.on(o.event_types.CHARACTER_MESSAGE_RENDERED,L),o.eventSource.on(o.event_types.USER_MESSAGE_RENDERED,L));case 1:return n.a(2)}}),n)}))));export{k as analyzeCurrentChat};